<?xml version="1.0" encoding="UTF-8" ?>

<project name="My subsite" default="help">

    <!-- Delete the previous build. -->
    <target name="delete-platform">
        <!--
            During the Drupal installation process the settings folder is write
            protected. Ensure it is writeable so it can be removed.
         -->
        <if>
            <available file="${platform.build.settings.dir}" type="dir" />
            <then>
                <chmod mode="0777" failonerror="true" verbose="false" quiet="true">
                    <fileset dir="${platform.build.settings.dir}" />
                </chmod>
            </then>
        </if>

        <echo msg="Delete previous build." />
        <!-- Use the faster native command on UNIX systems. -->
        <if>
            <os family="unix" />
            <then>
                <echo msg='rm -rf "${platform.build.dir}"' />
                <exec
                    command='rm -rf "${platform.build.dir}"'
                    dir="${project.basedir}"
                    passthru="true"
                    checkreturn="true"
                />
            </then>
            <else>
                <delete dir="${platform.build.dir}" includeemptydirs="true" failonerror="false" />
            </else>
        </if>
    </target>

    <!-- Make the subsite. -->
    <target name="make-subsite" depends="unpack-platform">
        <echo msg="Make the subsite." />
        <phingcall target="drush-make-no-core">
            <property name="drush.make.target.file" value="${subsite.make}" />
        </phingcall>
    </target>

    <!-- Generate the makefile used to download development modules. -->
    <target name="generate-development-makefile">
        <echo msg="Generate the makefile for development modules." />
        <if>
            <available file="${subsite.temporary.development.make}" type="file" property="development.makefile.available" />
            <then>
                <echo message="Deleting existing makefile." />
                <delete file="${subsite.temporary.development.make}" failonerror="false" />
            </then>
        </if>
        <drushmakefile
            makeFile="${subsite.temporary.development.make}"
            coreVersion="${drupal.core.version}"
            projects="${development.modules.download}"
            defaultProjectDir="${development.modules.location}"
        />
    </target>

    <!-- Download development modules. -->
    <target name="download-development-modules" depends="generate-development-makefile">
        <echo msg="Download development modules." />
        <phingcall target="drush-make-no-core">
            <property name="drush.make.target.file" value="${subsite.temporary.development.make}" />
        </phingcall>
    </target>

    <!-- Subtarget: execute a makefile with the no-core option. -->
    <target name="drush-make-no-core">
        <drush
            command="make"
            assume="yes"
            bin="${drush.bin}"
            pipe="yes"
            verbose="${drush.verbose}"
            root="${platform.build.dir}">
            <param>${drush.make.target.file}</param>
            <param>${platform.build.dir}</param>
            <!-- Increasing the concurrency improves the build time by a factor of 3. -->
            <option name="concurrency">10</option>
            <option name="no-patch-txt"></option>
            <!-- This option will allow us to build inside an existing folder. -->
            <option name="no-core"></option>
        </drush>
    </target>

    <!-- Symlink the source folders for easy development. -->
    <target name="link-subsite-resources">
        <!-- Symlink our custom modules. -->
        <symlink link="${platform.build.subsite.modules.custom.dir}" target="${subsite.resources.modules.dir}" />
        <!-- Symlink our custom features. -->
        <symlink link="${platform.build.subsite.modules.features.dir}" target="${subsite.resources.features.dir}" />
        <!-- Symlink our custom themes. Delete the empty folder which is created during Drush make. -->
        <delete dir="${platform.build.subsite.themes.dir}" includeemptydirs="true" failonerror="false" />
        <symlink link="${platform.build.subsite.themes.dir}" target="${subsite.resources.themes.dir}" />
        <!-- Symlink our custom PSR-4 code. -->
        <symlink link="${platform.build.subsite.source.dir}" target="${subsite.resources.source.dir}" />
        <!-- Symlink composer configuration. -->
        <symlink link="${platform.build.subsite.composer.json}" target="${subsite.resources.composer.json}" />
        <symlink link="${platform.build.subsite.composer.lock}" target="${subsite.resources.composer.lock}" />
    </target>

    <!-- Install Composer dependencies for the build system. -->
    <target name="install-build-dependencies">
        <composer command="install" composer="${composer.bin}">
            <arg value="--working-dir=${project.basedir}" />
        </composer>
    </target>

    <!-- Install Composer dependencies for the subsite. -->
    <target name="install-subsite-dependencies">
        <composer command="install" composer="${composer.bin}">
            <arg value="--working-dir=${platform.build.subsite.dir}" />
        </composer>
    </target>

    <!-- Link site document root to Webserver document root. -->
    <target
        name="link-docroot"
        description="Create a symlink from the build folder to the webserver document root.">
        <symlink link="${server.docroot}" target="${platform.build.dir}" overwrite="true" />
    </target>

    <!-- Update .htaccess. -->
    <target name="update-htaccess">
        <if>
            <istrue value="${drupal.htaccess.append.text}" />
            <then>
                <append destfile="${drupal.htaccess.path}" text="${drupal.htaccess.append.text}" />
            </then>
        </if>
    </target>

    <!-- Download the platform. -->
    <target name="download-platform">
        <!--
            The platform is very large so downloading it can take a long time.
            Only download it when it hasn't yet been downloaded.
         -->
        <if>
            <not>
                <available file="${platform.package.tarball}" type="file" />
            </not>
            <then>
                <!-- Create the destination directory if it doesn't exist. -->
                <mkdir dir="${platform.package.destination}" />
                <echo msg="Starting to download the platform. Depending on your connection this can take between 5-15 minutes. Go get some coffee." />
                <echo msg="This file will only be downloaded once and will be cached in ${platform.package.tarball}." />
                <echo msg="You can delete this cached file whenever you want to download a new version of the platform." />
                <continuousphp-config token="${platform.package.token}" />
                <continuousphp-package
                    provider="${platform.package.provider}"
                    repository="${platform.package.repository}"
                    reference="${platform.package.reference}"
                    destination="${platform.package.destination}"
                    property="platform.package.property"
                />
                <echo msg="Downloaded platform package reference ${platform.package.property}" />
            </then>
            <else>
                <echo msg="Skipping platform download, it is already downloaded at ${platform.package.tarball}. Delete this file if you want to download the latest version." />
            </else>
        </if>
    </target>

    <!-- Unpack the platform. -->
    <target name="unpack-platform" depends="download-platform, delete-platform">
        <!-- Use the faster native commands on UNIX systems. -->
        <if>
            <os family="unix" />
            <then>
                <echo msg='mkdir "${platform.build.dir}"' />
                <exec
                    command='mkdir "${platform.build.dir}"'
                    dir="${project.basedir}"
                    passthru="true"
                />
                <echo msg='tar xzf "${platform.package.tarball}" -C "${platform.build.dir}"' />
                <exec
                    command='tar xzf "${platform.package.tarball}" -C "${platform.build.dir}"'
                    dir="${project.basedir}"
                    passthru="true"
                    checkreturn="true"
                />
            </then>
            <else>
                <untar file="${platform.package.tarball}" todir="${platform.build.dir}" />
            </else>
        </if>
    </target>

    <!-- Download the Futurium feature package. -->
    <target name="download-futurium-features" description="Download the Futurium Features code">
        <echo msg="Downloading the Futurium features code" />
        <!-- Only clone if repository does not exist already -->
        <if>
            <not><available file="${futurium.features.gitfile}" /></not>
            <then>
                <!-- Set revision to HEAD if not already defined -->
                <property name="repo.revision" value="HEAD" override="false"/>

                <echo>Cloning ${futurium.features.repository} ${futurium.features.branch} into ${subsite.resources.lib.dir}</echo>
                <!-- The [`gitclone` task](http://www.phing.info/docs/guide/stable/chapters/appendixes/AppendixC-OptionalTasks.html#GitCloneTask)
                     does not seem to work. Use exec instead. -->

                <gitclone
                        repository="${futurium.features.repository}"
                        targetPath="${subsite.resources.lib.dir}" />
                <gitpull
                        repository="${subsite.resources.lib.dir}"
                        source="origin" refspec="${futurium.features.branch}"
                        strategy="recursive" keep="true"
                        force="true" quiet="true" norebase="true" />
            </then>
            <else>
                <echo msg="Pulling changes from the Futurium features repository" />
                <exec command="git checkout ${futurium.features.branch}" dir="${subsite.resources.lib.dir}"/>
                <exec command="git pull" dir="${subsite.resources.lib.dir}"/>
            </else>
        </if>
    </target>

    <!-- Copy subsite resources into the build folder. -->
    <target name="copy-subsite-resources">
        <echo msg="Copy subsite resources into the build folder." />
        <!-- Copy the source folders for easy development. -->
        <!-- Copy our custom modules. -->
        <mkdir dir="${platform.build.subsite.modules.custom.dir}" />
        <exec command='cp -R ${subsite.resources.modules.dir}/* ${platform.build.subsite.modules.custom.dir}'
                passthru="true"
                checkreturn="true" />
        <!-- Copy our custom features. -->
        <mkdir dir="${platform.build.subsite.modules.features.dir}" />
        <exec command='cp -R ${subsite.resources.features.dir}/* ${platform.build.subsite.modules.features.dir}'
              passthru="true"
              checkreturn="true" />
        <!-- Copy our custom themes. Delete the empty folder which is created during Drush make. -->
        <mkdir dir="${platform.build.subsite.themes.dir}" />
        <exec command='cp -R ${subsite.resources.themes.dir}/* ${platform.build.subsite.themes.dir}'
              passthru="true"
              checkreturn="true" />
        <!-- Copy composer configuration. -->
        <exec command='cp -R ${subsite.resources.composer.json} ${platform.build.subsite.composer.json}'
              passthru="true"
              checkreturn="true" />
        <exec command='cp -R ${subsite.resources.composer.lock} ${platform.build.subsite.composer.lock}'
              passthru="true"
              checkreturn="true" />
    </target>

    <target
        name="build-dev"
        description="Build a local development version of the subsite."
        depends="install-build-dependencies, delete-platform, download-platform, unpack-platform, make-subsite, link-subsite-resources, install-subsite-dependencies, setup-behat, update-htaccess, setup-php-codesniffer, download-development-modules" />

    <target
        name="build-dist"
        description="Build a version of the subsite intended to distribute as a release package."
        depends="install-build-dependencies, delete-platform, download-platform, unpack-platform, make-subsite, copy-subsite-resources, download-development-modules" />

</project>
